# 20231127
## 1022
```
(brats2023) tom@b760:~/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch$ python train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 1 --eval_freq 1 --save_model --save_pred --exp_dir ./saved_model/
20231127 10:21:14 INFO: -------------------- New Experiment --------------------
20231127 10:21:14 INFO: train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 1 --eval_freq 1 --save_model --save_pred --exp_dir ./saved_model/
20231127 10:21:14 INFO: Namespace(amp=False, batch_size=2, beta1=0.9, beta2=0.999, block='plain', cases_split='./data/split/brats2023_split_fold0.csv', channels_list=[32, 64, 128, 256, 320, 320], clip_grad=False, comment='', data_parallel=False, data_root='../brats2023/', dataset='brats2023', deep_supervision=False, dropout_prob=0.0, ds_layer=4, epochs=1, eval_freq=1, exp_dir='./saved_model/_brats2023_unet_adamw_none_pos1.0_neg1.0_1127_102114', gpus=None, infer_batch_size=4, input_channels=4, kernel_size=3, lr=0.001, lr_gamma=0.1, milestones=[60, 80], neg_ratio=1.0, norm='instance', num_classes=3, num_workers=6, optim='adamw', patch_overlap=0.5, patch_size=128, pos_ratio=1.0, print_freq=5, save_freq=10, save_model=True, save_pred=True, scheduler='none', seed=1000, sliding_window_mode='constant', sw_batch_size=2, unet_arch='unet', warmup_epochs=5, weight_decay=0.0001, weight_path=None)
20231127 10:21:14 INFO: ==> Training starts...
preds (<class 'list'>) length:  1
preds[0] (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 3, 128, 128, 128)
label (<class 'monai.data.meta_tensor.MetaTensor'>) length:  2
label (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 3, 128, 128, 128)
Traceback (most recent call last):
  File "train_brats2021.py", line 263, in <module>
    main()
  File "train_brats2021.py", line 227, in main
    train(args, epoch, model, train_loader, loss, optimizer, scheduler, scaler, writer, logger)
  File "train_brats2021.py", line 73, in train
    bce_loss, dsc_loss = loss_fn(preds, label)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1518, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1527, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/tom/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch/utils/loss.py", line 132, in forward
    bce_loss = self.bce(net_output, target)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1518, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1527, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/loss.py", line 725, in forward
    return F.binary_cross_entropy_with_logits(input, target,
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/functional.py", line 3176, in binary_cross_entropy_with_logits
    return handle_torch_function(
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/overrides.py", line 1577, in handle_torch_function
    result = torch_func_method(public_api, types, args, kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/monai/data/meta_tensor.py", line 245, in __torch_function__
    ret = super().__torch_function__(func, types, args, kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/_tensor.py", line 1386, in __torch_function__
    ret = func(*args, **kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/functional.py", line 3192, in binary_cross_entropy_with_logits
    if not (target.size() == input.size()):
AttributeError: 'list' object has no attribute 'size'
```
- info when defining num_classes = 4
```
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
```
## 1038
- ~~stack all labels in a batch into one~~ and compare it with preds[0]
- no need to stack labels, only need to retrieve preds[0]
```python
label_stacked = torch.stack(tuple(x_i for x_i in torch.unbind(label, dim=1)), dim=1)  
bce_loss, dsc_loss = loss_fn(preds[0], label_stacked)
```
- error info
```
(brats2023) tom@b760:~/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch$ python train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 1 --eval_freq 1 --save_model --save_pred --exp_dir ./saved_model/ --num_classes 4
20231127 10:39:59 INFO: -------------------- New Experiment --------------------
20231127 10:39:59 INFO: train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 1 --eval_freq 1 --save_model --save_pred --exp_dir ./saved_model/ --num_classes 4
20231127 10:39:59 INFO: Namespace(amp=False, batch_size=2, beta1=0.9, beta2=0.999, block='plain', cases_split='./data/split/brats2023_split_fold0.csv', channels_list=[32, 64, 128, 256, 320, 320], clip_grad=False, comment='', data_parallel=False, data_root='../brats2023/', dataset='brats2023', deep_supervision=False, dropout_prob=0.0, ds_layer=4, epochs=1, eval_freq=1, exp_dir='./saved_model/_brats2023_unet_adamw_none_pos1.0_neg1.0_1127_103959', gpus=None, infer_batch_size=4, input_channels=4, kernel_size=3, lr=0.001, lr_gamma=0.1, milestones=[60, 80], neg_ratio=1.0, norm='instance', num_classes=4, num_workers=6, optim='adamw', patch_overlap=0.5, patch_size=128, pos_ratio=1.0, print_freq=5, save_freq=10, save_model=True, save_pred=True, scheduler='none', seed=1000, sliding_window_mode='constant', sw_batch_size=2, unet_arch='unet', warmup_epochs=5, weight_decay=0.0001, weight_path=None)
20231127 10:39:59 INFO: ==> Training starts...
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
preds (<class 'list'>) length:  1
preds[0] (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 4, 128, 128, 128)
label (<class 'monai.data.meta_tensor.MetaTensor'>) length:  2
label (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 3, 128, 128, 128)
Traceback (most recent call last):
  File "train_brats2021.py", line 263, in <module>
    main()
  File "train_brats2021.py", line 227, in main
    train(args, epoch, model, train_loader, loss, optimizer, scheduler, scaler, writer, logger)
  File "train_brats2021.py", line 73, in train
    bce_loss, dsc_loss = loss_fn(preds[0], label_stacked)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1518, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1527, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/tom/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch/utils/loss.py", line 132, in forward
    bce_loss = self.bce(net_output, target)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1518, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1527, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/loss.py", line 725, in forward
    return F.binary_cross_entropy_with_logits(input, target,
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/functional.py", line 3176, in binary_cross_entropy_with_logits
    return handle_torch_function(
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/overrides.py", line 1577, in handle_torch_function
    result = torch_func_method(public_api, types, args, kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/monai/data/meta_tensor.py", line 245, in __torch_function__
    ret = super().__torch_function__(func, types, args, kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/_tensor.py", line 1386, in __torch_function__
    ret = func(*args, **kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/functional.py", line 3193, in binary_cross_entropy_with_logits
    raise ValueError(f"Target size ({target.size()}) must be the same as input size ({input.size()})")
ValueError: Target size (torch.Size([2, 3, 128, 128, 128])) must be the same as input size (torch.Size([2, 4, 128, 128, 128]))
```
- info when defining num_classes=3
```
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
preds (<class 'list'>) length:  1
preds[0] (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 3, 128, 128, 128)
label (<class 'monai.data.meta_tensor.MetaTensor'>) length:  2
label (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 3, 128, 128, 128)
```

```
(brats2023) tom@b760:~/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch$ python train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 3
20231127 11:54:28 INFO: -------------------- New Experiment --------------------
20231127 11:54:28 INFO: train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 3
20231127 11:54:28 INFO: Namespace(amp=False, batch_size=2, beta1=0.9, beta2=0.999, block='plain', cases_split='./data/split/brats2023_split_fold0.csv', channels_list=[32, 64, 128, 256, 320, 320], clip_grad=False, comment='', data_parallel=False, data_root='../brats2023/', dataset='brats2023', deep_supervision=False, dropout_prob=0.0, ds_layer=4, epochs=3, eval_freq=1, exp_dir='saved_model/_brats2023_unet_adamw_none_pos1.0_neg1.0_1127_115428', gpus=None, infer_batch_size=4, input_channels=4, kernel_size=3, lr=0.001, lr_gamma=0.1, milestones=[60, 80], neg_ratio=1.0, norm='instance', num_classes=3, num_workers=6, optim='adamw', patch_overlap=0.5, patch_size=128, pos_ratio=1.0, print_freq=5, save_freq=10, save_model=True, save_pred=True, scheduler='none', seed=1000, sliding_window_mode='constant', sw_batch_size=2, unet_arch='unet', warmup_epochs=5, weight_decay=0.0001, weight_path=None)
20231127 11:54:29 INFO: ==> Training starts...
mask.shape: (240, 240, 155)
mask.shape: (240, 240, 155)
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
mask.shape: (240, 240, 155)
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
preds (<class 'list'>) length:  1
preds[0] (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 3, 128, 128, 128)
label (<class 'monai.data.meta_tensor.MetaTensor'>) length:  2
label (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 3, 128, 128, 128)
20231127 11:54:53 INFO: Train: [0][1/2] Time 24.946 (24.946)    Data  4.010 ( 4.010)    BCE 0.7398 (0.7398)     Dice 0.9618 (0.9618) Loss 1.7016 (1.7016)
preds (<class 'list'>) length:  1
preds[0] (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (1, 3, 128, 128, 128)
label (<class 'monai.data.meta_tensor.MetaTensor'>) length:  1
label (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (1, 3, 128, 128, 128)
20231127 11:55:04 INFO: ==> Validation starts...
mask.shape: (240, 240, 155)
item["image"].shape: (4, 240, 240, 155)
item["label"].shape: (3, 240, 240, 155)
20231127 11:55:11 INFO: Val: [0][1/1]   Time  7.448 ( 7.448)    Dice_WT 0.434 (0.434)   Dice_TC 0.432 (0.432)   Dice_ET 0.278 (0.278)HD95_WT  90.565 ( 90.565)        HD95_TC  87.527 ( 87.527)       HD95_ET 130.604 (130.604)
20231127 11:55:11 INFO: ==> Validation ends...
mask.shape: (240, 240, 155)
mask.shape: (240, 240, 155)
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
mask.shape: (240, 240, 155)
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
preds (<class 'list'>) length:  1
preds[0] (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 3, 128, 128, 128)
label (<class 'monai.data.meta_tensor.MetaTensor'>) length:  2
label (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 3, 128, 128, 128)
20231127 11:55:17 INFO: Train: [1][1/2] Time  5.196 ( 5.196)    Data  4.493 ( 4.493)    BCE 0.6996 (0.6996)     Dice 0.9459 (0.9459) Loss 1.6454 (1.6454)
preds (<class 'list'>) length:  1
preds[0] (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (1, 3, 128, 128, 128)
label (<class 'monai.data.meta_tensor.MetaTensor'>) length:  1
label (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (1, 3, 128, 128, 128)
20231127 11:55:17 INFO: ==> Validation starts...
mask.shape: (240, 240, 155)
item["image"].shape: (4, 240, 240, 155)
item["label"].shape: (3, 240, 240, 155)
20231127 11:55:24 INFO: Val: [1][1/1]   Time  7.282 ( 7.282)    Dice_WT 0.512 (0.512)   Dice_TC 0.482 (0.482)   Dice_ET 0.387 (0.387)HD95_WT  83.287 ( 83.287)        HD95_TC  82.873 ( 82.873)       HD95_ET  90.934 ( 90.934)
20231127 11:55:24 INFO: ==> Validation ends...
mask.shape: (240, 240, 155)
mask.shape: (240, 240, 155)
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
mask.shape: (240, 240, 155)
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (3, 128, 128, 128)
preds (<class 'list'>) length:  1
preds[0] (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 3, 128, 128, 128)
label (<class 'monai.data.meta_tensor.MetaTensor'>) length:  2
label (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 3, 128, 128, 128)
20231127 11:55:29 INFO: Train: [2][1/2] Time  4.627 ( 4.627)    Data  3.923 ( 3.923)    BCE 0.6472 (0.6472)     Dice 0.9386 (0.9386) Loss 1.5858 (1.5858)
preds (<class 'list'>) length:  1
preds[0] (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (1, 3, 128, 128, 128)
label (<class 'monai.data.meta_tensor.MetaTensor'>) length:  1
label (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (1, 3, 128, 128, 128)
20231127 11:55:29 INFO: ==> Validation starts...
mask.shape: (240, 240, 155)
item["image"].shape: (4, 240, 240, 155)
item["label"].shape: (3, 240, 240, 155)
20231127 11:55:37 INFO: Val: [2][1/1]   Time  7.363 ( 7.363)    Dice_WT 0.542 (0.542)   Dice_TC 0.527 (0.527)   Dice_ET 0.361 (0.361)HD95_WT 126.925 (126.925)        HD95_TC  90.144 ( 90.144)       HD95_ET 127.793 (127.793)
20231127 11:55:37 INFO: ==> Validation ends...
20231127 11:55:37 INFO: ==> Testing starts...
mask.shape: (240, 240, 155)
item["image"].shape: (4, 240, 240, 155)
item["label"].shape: (3, 240, 240, 155)
20231127 11:55:45 INFO: Test: [1][1/1]  Time  7.957 ( 7.957)    Dice_WT 0.526 (0.526)   Dice_TC 0.499 (0.499)   Dice_ET 0.373 (0.373)HD95_WT  73.580 ( 73.580)        HD95_TC  82.517 ( 82.517)       HD95_ET 118.634 (118.634)
20231127 11:55:45 INFO: ==> Saving...
20231127 11:55:45 INFO: ==> Testing ends...
```

- label converter
```python
# /home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/monai/transforms/utility/dictionary.py
class ConvertToMultiChannelBasedOnBratsClassesd(MapTransform):
    """
    Dictionary-based wrapper of :py:class:`monai.transforms.ConvertToMultiChannelBasedOnBratsClasses`.
    Convert labels to multi channels based on brats18 classes:
    label 1 is the necrotic and non-enhancing tumor core
    label 2 is the peritumoral edema
    label 4 is the GD-enhancing tumor
    The possible classes are TC (Tumor core), WT (Whole tumor)
    and ET (Enhancing tumor).
    """

    backend = ConvertToMultiChannelBasedOnBratsClasses.backend

    def __init__(self, keys: KeysCollection, allow_missing_keys: bool = False):
        super().__init__(keys, allow_missing_keys)
        self.converter = ConvertToMultiChannelBasedOnBratsClasses()

    def __call__(self, data: Mapping[Hashable, NdarrayOrTensor]) -> Dict[Hashable, NdarrayOrTensor]:
        d = dict(data)
        for key in self.key_iterator(d):
            d[key] = self.converter(d[key])
        return d
```
```python
# /home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/monai/transforms/utility/array.py
class ConvertToMultiChannelBasedOnBratsClasses(Transform):
    """
    Convert labels to multi channels based on brats18 classes:
    label 1 is the necrotic and non-enhancing tumor core
    label 2 is the the peritumoral edema
    label 4 is the GD-enhancing tumor
    The possible classes are TC (Tumor core), WT (Whole tumor)
    and ET (Enhancing tumor).
    """

    backend = [TransformBackends.TORCH, TransformBackends.NUMPY]

    def __call__(self, img: NdarrayOrTensor) -> NdarrayOrTensor:
        # if img has channel dim, squeeze it
        if img.ndim == 4 and img.shape[0] == 1:
            img = img.squeeze(0)

        result = [(img == 1) | (img == 4), (img == 1) | (img == 4) | (img == 2), img == 4]
        # merge labels 1 (tumor non-enh) and 4 (tumor enh) and 2 (large edema) to WT
        # label 4 is ET
        return torch.stack(result, dim=0) if isinstance(img, torch.Tensor) else np.stack(result, axis=0)
```

## 1310
- loss function: 
```python
# /home/tom/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch/utils/loss.py
class SoftDiceBCEWithLogitsLoss(nn.Module):
    def __init__(self, dice_smooth=1.0):
        """Binary Cross Entropy & Soft Dice Loss 
        
        Seperately return BCEWithLogitsloss and Dice loss.

        BCEWithLogitsloss is more numerically stable than Sigmoid + BCE
        """
        super(SoftDiceBCEWithLogitsLoss, self).__init__()

        self.bce = nn.BCEWithLogitsLoss()
        self.dsc = SoftDiceWithLogitsLoss(nonlinear='sigmoid', smooth=dice_smooth)

    def forward(self, net_output:Tensor, target:Tensor):
        """Compute Binary Cross Entropy & Region Dice Loss

        Args:
            net_output (Tensor): [B, C, ...]
            target (Tensor): [B, C, ...]
        """
        # print(f'net_output ({type(net_output)}): ')
        # print(f'target ({type(target)}): ')
        bce_loss = self.bce(net_output, target)
        dsc_loss = self.dsc(net_output, target)

        return bce_loss, dsc_loss
```
- self.bce = nn.BCEWithLogitsLoss()
```py
# /home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/loss.py
def __init__(self, weight: Optional[Tensor] = None, size_average=None, reduce=None, reduction: str = 'mean',
                 pos_weight: Optional[Tensor] = None) -> None:
        super().__init__(size_average, reduce, reduction)
        self.register_buffer('weight', weight)
        self.register_buffer('pos_weight', pos_weight)
        self.weight: Optional[Tensor]
        self.pos_weight: Optional[Tensor]

    def forward(self, input: Tensor, target: Tensor) -> Tensor:
        return F.binary_cross_entropy_with_logits(input, target,
                                                  self.weight,
                                                  pos_weight=self.pos_weight,
                                                  reduction=self.reduction)
```
- self.dsc = SoftDiceWithLogitsLoss(nonlinear='sigmoid', smooth=dice_smooth)
```py
# /home/tom/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch/utils/loss.py
class SoftDiceWithLogitsLoss(nn.Module):
    ''' Adapt from nnUNet repo'''
    def __init__(self, nonlinear='sigmoid', smooth=1.0):
        super(SoftDiceWithLogitsLoss, self).__init__()
        self.smooth = smooth
        self.nonlinear = nonlinear

    def forward(self, x, y, loss_mask=None):
        shp_x = x.shape

        axes = list(range(2, len(shp_x)))

        if self.nonlinear == 'sigmoid':
            x = robust_sigmoid(x)
        else:
            raise NotImplementedError(self.nonlinear)

        tp, fp, fn, _ = get_tp_fp_fn_tn(x, y, axes, loss_mask, False)

        nominator = 2 * tp + self.smooth
        denominator = 2 * tp + fp + fn + self.smooth

        dc = nominator / (denominator + 1e-8)
        
        dc = dc.mean()

        return 1 - dc
```
## 1400
- encounter CUDA assertion fail after converting label to one hot embedding
```
(brats2023) tom@b760:~/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch$ python train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 4
20231127 13:28:31 INFO: -------------------- New Experiment --------------------
20231127 13:28:31 INFO: train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 4
20231127 13:28:31 INFO: Namespace(amp=False, batch_size=2, beta1=0.9, beta2=0.999, block='plain', cases_split='./data/split/brats2023_split_fold0.csv', channels_list=[32, 64, 128, 256, 320, 320], clip_grad=False, comment='', data_parallel=False, data_root='../brats2023/', dataset='brats2023', deep_supervision=False, dropout_prob=0.0, ds_layer=4, epochs=3, eval_freq=1, exp_dir='saved_model/_brats2023_unet_adamw_none_pos1.0_neg1.0_1127_132831', gpus=None, infer_batch_size=4, input_channels=4, kernel_size=3, lr=0.001, lr_gamma=0.1, milestones=[60, 80], neg_ratio=1.0, norm='instance', num_classes=4, num_workers=6, optim='adamw', patch_overlap=0.5, patch_size=128, pos_ratio=1.0, print_freq=5, save_freq=10, save_model=True, save_pred=True, scheduler='none', seed=1000, sliding_window_mode='constant', sw_batch_size=2, unet_arch='unet', warmup_epochs=5, weight_decay=0.0001, weight_path=None)
20231127 13:28:31 INFO: ==> Training starts...
mask.shape (before transform): (240, 240, 155)
self.transforms: <monai.transforms.compose.Compose object at 0x7fb774cdec40>
mask.shape (before transform): (240, 240, 155)
self.transforms: <monai.transforms.compose.Compose object at 0x7fb774cdec40>
mask.shape (after transform): (240, 240, 155)
mask unique values: [0 1 2 3 4]
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (1, 128, 128, 128)
item["label"] unique values: [0 1 2 3 4]
mask.shape (after transform): (240, 240, 155)
mask unique values: [0 1 2 3 4]
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (1, 128, 128, 128)
item["label"] unique values: [0 1 2 3 4]
mask.shape (before transform): (240, 240, 155)
self.transforms: <monai.transforms.compose.Compose object at 0x7fb774cdec40>
mask.shape (after transform): (240, 240, 155)
mask unique values: [0 1 2 3 4]
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (1, 128, 128, 128)
item["label"] unique values: [0 1 2 3 4]
preds (<class 'list'>) length:  1
preds[0] (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 4, 128, 128, 128)
label (<class 'monai.data.meta_tensor.MetaTensor'>) length:  2
label (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 1, 128, 128, 128)
one_hot_label shape (<class 'monai.data.meta_tensor.MetaTensor'>): (2, 4, 128, 128, 128)
../aten/src/ATen/native/cuda/ScatterGatherKernel.cu:365: operator(): block: [1617,0,0], thread: [100,0,0] Assertion `idx_dim >= 0 && idx_dim < index_size && "index out of bounds"` failed.
Traceback (most recent call last):
  File "train_brats2021.py", line 283, in <module>
    main()
  File "train_brats2021.py", line 247, in main
    train(args, epoch, model, train_loader, loss, optimizer, scheduler, scaler, writer, logger)
  File "train_brats2021.py", line 87, in train
    bce_loss, dsc_loss = loss_fn(preds[0], one_hot_label)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1518, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1527, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/tom/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch/utils/loss.py", line 132, in forward
    bce_loss = self.bce(net_output, target)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1518, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/module.py", line 1527, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/modules/loss.py", line 725, in forward
    return F.binary_cross_entropy_with_logits(input, target,
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/functional.py", line 3176, in binary_cross_entropy_with_logits
    return handle_torch_function(
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/overrides.py", line 1577, in handle_torch_function
    result = torch_func_method(public_api, types, args, kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/monai/data/meta_tensor.py", line 245, in __torch_function__
    ret = super().__torch_function__(func, types, args, kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/_tensor.py", line 1386, in __torch_function__
    ret = func(*args, **kwargs)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/torch/nn/functional.py", line 3195, in binary_cross_entropy_with_logits
    return torch.binary_cross_entropy_with_logits(input, target, weight, pos_weight, reduction_enum)
RuntimeError: CUDA error: device-side assert triggered
CUDA kernel errors might be asynchronously reported at some other API call, so the stacktrace below might be incorrect.
For debugging consider passing CUDA_LAUNCH_BLOCKING=1.
Compile with `TORCH_USE_CUDA_DSA` to enable device-side assertions.
```
- solved: https://blog.csdn.net/Penta_Kill_5/article/details/118085718
- number of classes [0, 1, 2, 3, 4] (0 represents background) -> (num_classes = 5) in label tensor does not match the pre-defined num_classes (4)

## 1527
- cannot compute Hausdorff distance and Dice score
```
(brats2023) tom@b760:~/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch$ python train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 5
20231127 16:21:56 INFO: -------------------- New Experiment --------------------
20231127 16:21:56 INFO: train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 5
20231127 16:21:56 INFO: Namespace(amp=False, batch_size=2, beta1=0.9, beta2=0.999, block='plain', cases_split='./data/split/brats2023_split_fold0.csv', channels_list=[32, 64, 128, 256, 320, 320], clip_grad=False, comment='', data_parallel=False, data_root='../brats2023/', dataset='brats2023', deep_supervision=False, dropout_prob=0.0, ds_layer=4, epochs=3, eval_freq=1, exp_dir='saved_model/_brats2023_unet_adamw_none_pos1.0_neg1.0_1127_162156', gpus=None, infer_batch_size=4, input_channels=4, kernel_size=3, lr=0.001, lr_gamma=0.1, milestones=[60, 80], neg_ratio=1.0, norm='instance', num_classes=5, num_workers=6, optim='adamw', patch_overlap=0.5, patch_size=128, pos_ratio=1.0, print_freq=5, save_freq=10, save_model=True, save_pred=True, scheduler='none', seed=1000, sliding_window_mode='constant', sw_batch_size=2, unet_arch='unet', warmup_epochs=5, weight_decay=0.0001, weight_path=None)
20231127 16:21:57 INFO: ==> Training starts...
mask.shape (before transform): (240, 240, 155)
self.transforms: <monai.transforms.compose.Compose object at 0x7f1f378ceca0>
mask.shape (before transform): (240, 240, 155)
self.transforms: <monai.transforms.compose.Compose object at 0x7f1f378ceca0>
mask.shape (after transform): (240, 240, 155)
mask unique values: [0 1 2 3 4]
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (1, 128, 128, 128)
item["label"] unique values: [0 1 2 3 4]
mask.shape (after transform): (240, 240, 155)
mask unique values: [0 1 2 3 4]
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (1, 128, 128, 128)
item["label"] unique values: [0 1 2 3 4]
mask.shape (before transform): (240, 240, 155)
self.transforms: <monai.transforms.compose.Compose object at 0x7f1f378ceca0>
mask.shape (after transform): (240, 240, 155)
mask unique values: [0 1 2 3 4]
item["image"].shape: (4, 128, 128, 128)
item["label"].shape: (1, 128, 128, 128)
item["label"] unique values: [0 1 2 3 4]
preds (<class 'list'>) length:  1
preds[0] (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 5, 128, 128, 128)
label (<class 'monai.data.meta_tensor.MetaTensor'>) length:  2
label (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (2, 1, 128, 128, 128)
one_hot_label shape (<class 'monai.data.meta_tensor.MetaTensor'>): (2, 5, 128, 128, 128)
20231127 16:22:23 INFO: Train: [0][1/2] Time 26.160 (26.160)    Data  5.265 ( 5.265)    BCE 0.6841 (0.6841)     Dice 0.8557 (0.8557) Loss 1.5398 (1.5398)
preds (<class 'list'>) length:  1
preds[0] (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (1, 5, 128, 128, 128)
label (<class 'monai.data.meta_tensor.MetaTensor'>) length:  1
label (<class 'monai.data.meta_tensor.MetaTensor'>) shape: (1, 1, 128, 128, 128)
one_hot_label shape (<class 'monai.data.meta_tensor.MetaTensor'>): (1, 5, 128, 128, 128)
20231127 16:22:33 INFO: ==> Validation starts...
mask.shape (before transform): (240, 240, 155)
self.transforms: <monai.transforms.compose.Compose object at 0x7f1f378db310>
mask.shape (after transform): (240, 240, 155)
mask unique values: [0 1 2 3 4]
item["image"].shape: (4, 240, 240, 155)
item["label"].shape: (1, 240, 240, 155)
item["label"] unique values: [0 1 2 3 4]
seg_map (<class 'monai.data.meta_tensor.MetaTensor'>):  (1, 5, 240, 240, 155)
label (<class 'monai.data.meta_tensor.MetaTensor'>):  (1, 1, 240, 240, 155)
Traceback (most recent call last):
  File "train_brats2021.py", line 288, in <module>
    main()
  File "train_brats2021.py", line 258, in main
    val_metrics = infer(args, epoch, model, val_loader, writer, logger, mode='val')
  File "train_brats2021.py", line 183, in infer
    case_metrics_meter.update(dice, hd95, brats_names, bsz)
  File "/home/tom/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch/utils/misc.py", line 73, in update
    hd95[i, 1], hd95[i, 0], hd95[i, 2],
IndexError: index 1 is out of bounds for axis 1 with size 1
```
- solved: convert label to one hot embedding

## 1631
- modification: change origianal evaluation metrics to our metrics
```
(brats2023) tom@b760:~/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch$ python train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 5
20231127 16:31:40 INFO: -------------------- New Experiment --------------------
20231127 16:31:40 INFO: train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 5
20231127 16:31:40 INFO: Namespace(amp=False, batch_size=2, beta1=0.9, beta2=0.999, block='plain', cases_split='./data/split/brats2023_split_fold0.csv', channels_list=[32, 64, 128, 256, 320, 320], clip_grad=False, comment='', data_parallel=False, data_root='../brats2023/', dataset='brats2023', deep_supervision=False, dropout_prob=0.0, ds_layer=4, epochs=3, eval_freq=1, exp_dir='saved_model/_brats2023_unet_adamw_none_pos1.0_neg1.0_1127_163140', gpus=None, infer_batch_size=4, input_channels=4, kernel_size=3, lr=0.001, lr_gamma=0.1, milestones=[60, 80], neg_ratio=1.0, norm='instance', num_classes=5, num_workers=6, optim='adamw', patch_overlap=0.5, patch_size=128, pos_ratio=1.0, print_freq=5, save_freq=10, save_model=True, save_pred=True, scheduler='none', seed=1000, sliding_window_mode='constant', sw_batch_size=2, unet_arch='unet', warmup_epochs=5, weight_decay=0.0001, weight_path=None)
20231127 16:31:40 INFO: ==> Training starts...
20231127 16:32:06 INFO: Train: [0][1/2] Time 25.597 (25.597)    Data  4.496 ( 4.496)    BCE 0.6831 (0.6831)     Dice 0.8541 (0.8541) Loss 1.5373 (1.5373)
20231127 16:32:17 INFO: ==> Validation starts...
seg_map (<class 'monai.data.meta_tensor.MetaTensor'>):  (1, 5, 240, 240, 155)
label (<class 'monai.data.meta_tensor.MetaTensor'>):  (1, 1, 240, 240, 155)
Traceback (most recent call last):
  File "train_brats2021.py", line 297, in <module>
    main()
  File "train_brats2021.py", line 267, in main
    val_metrics = infer(args, epoch, model, val_loader, writer, logger, mode='val')
  File "train_brats2021.py", line 201, in infer
    f"Dice_BG {dice[:, 0].mean():.3f} ({mean_metrics['Dice_BG']:.3f})", # background
KeyError: 'Dice_BG'
```
- solved: change cols in misc.py
## 1641
- update metrics error
```
(brats2023) tom@b760:~/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch$ python train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 5
20231127 16:37:10 INFO: -------------------- New Experiment --------------------
20231127 16:37:10 INFO: train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 5
20231127 16:37:10 INFO: Namespace(amp=False, batch_size=2, beta1=0.9, beta2=0.999, block='plain', cases_split='./data/split/brats2023_split_fold0.csv', channels_list=[32, 64, 128, 256, 320, 320], clip_grad=False, comment='', data_parallel=False, data_root='../brats2023/', dataset='brats2023', deep_supervision=False, dropout_prob=0.0, ds_layer=4, epochs=3, eval_freq=1, exp_dir='saved_model/_brats2023_unet_adamw_none_pos1.0_neg1.0_1127_163710', gpus=None, infer_batch_size=4, input_channels=4, kernel_size=3, lr=0.001, lr_gamma=0.1, milestones=[60, 80], neg_ratio=1.0, norm='instance', num_classes=5, num_workers=6, optim='adamw', patch_overlap=0.5, patch_size=128, pos_ratio=1.0, print_freq=5, save_freq=10, save_model=True, save_pred=True, scheduler='none', seed=1000, sliding_window_mode='constant', sw_batch_size=2, unet_arch='unet', warmup_epochs=5, weight_decay=0.0001, weight_path=None)
20231127 16:37:10 INFO: ==> Training starts...
20231127 16:37:37 INFO: Train: [0][1/2] Time 26.430 (26.430)    Data  5.110 ( 5.110)    BCE 0.6818 (0.6818)     Dice 0.8444 (0.8444) Loss 1.5262 (1.5262)
20231127 16:37:48 INFO: ==> Validation starts...
seg_map (<class 'monai.data.meta_tensor.MetaTensor'>):  (1, 5, 240, 240, 155)
label (<class 'monai.data.meta_tensor.MetaTensor'>):  (1, 1, 240, 240, 155)
Traceback (most recent call last):
  File "train_brats2021.py", line 297, in <module>
    main()
  File "train_brats2021.py", line 267, in main
    val_metrics = infer(args, epoch, model, val_loader, writer, logger, mode='val')
  File "train_brats2021.py", line 188, in infer
    case_metrics_meter.update(dice, hd95, brats_names, bsz)
  File "/home/tom/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch/utils/misc.py", line 71, in update
    self.cases.loc[names[i]] = [
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/pandas/core/indexing.py", line 723, in __setitem__
    iloc._setitem_with_indexer(indexer, value, self.name)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/pandas/core/indexing.py", line 1724, in _setitem_with_indexer
    self._setitem_with_indexer_missing(indexer, value)
  File "/home/tom/anaconda3/envs/brats2023/lib/python3.8/site-packages/pandas/core/indexing.py", line 2027, in _setitem_with_indexer_missing
    raise ValueError("cannot set a row with mismatched columns")
ValueError: cannot set a row with mismatched columns
```
- solved: change the corresponding dataframe 
- output with some parameters prints: 
```
(brats2023) tom@b760:~/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch$ python train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 5
20231127 16:59:21 INFO: -------------------- New Experiment --------------------
20231127 16:59:21 INFO: train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 5
20231127 16:59:21 INFO: Namespace(amp=False, batch_size=2, beta1=0.9, beta2=0.999, block='plain', cases_split='./data/split/brats2023_split_fold0.csv', channels_list=[32, 64, 128, 256, 320, 320], clip_grad=False, comment='', data_parallel=False, data_root='../brats2023/', dataset='brats2023', deep_supervision=False, dropout_prob=0.0, ds_layer=4, epochs=3, eval_freq=1, exp_dir='saved_model/_brats2023_unet_adamw_none_pos1.0_neg1.0_1127_165921', gpus=None, infer_batch_size=4, input_channels=4, kernel_size=3, lr=0.001, lr_gamma=0.1, milestones=[60, 80], neg_ratio=1.0, norm='instance', num_classes=5, num_workers=6, optim='adamw', patch_overlap=0.5, patch_size=128, pos_ratio=1.0, print_freq=5, save_freq=10, save_model=True, save_pred=True, scheduler='none', seed=1000, sliding_window_mode='constant', sw_batch_size=2, unet_arch='unet', warmup_epochs=5, weight_decay=0.0001, weight_path=None)
20231127 16:59:21 INFO: ==> Training starts...
20231127 16:59:46 INFO: Train: [0][1/2] Time 25.590 (25.590)    Data  4.720 ( 4.720)    BCE 0.6822 (0.6822)     Dice 0.8446 (0.8446) Loss 1.5268 (1.5268)
20231127 16:59:57 INFO: ==> Validation starts...
seg_map (<class 'monai.data.meta_tensor.MetaTensor'>):  (1, 5, 240, 240, 155)
label (<class 'monai.data.meta_tensor.MetaTensor'>):  (1, 1, 240, 240, 155)
brats names: ['1_100918']
[[6.9798022e-03 4.9516960e-11 3.8295100e-10 3.4158489e-11 4.2008334e-11]]
[[ 74.12152184  95.60857702 373.1287     373.1287     373.1287    ]]
Empty DataFrame
Columns: [Dice_BG, Dice_TC, Dice_ED, Dice_ET, Dice_RC, HD95_BG, HD95_TC, HD95_ED, HD95_ET, HD95_RC]
Index: []
['1_100918']
1
4.951696e-11
0.006979802
3.82951e-10
95.60857702110204
74.1215218408257
373.1287
20231127 17:00:03 INFO: Val: [0][1/1]   Time  6.272 ( 6.272)    Dice_BG 0.007 (0.007)   Dice_TC 0.000 (0.000)   Dice_ED 0.000 (0.000)Dice_ET 0.000 (0.000)    Dice_RC 0.000 (0.000)   HD95_BG  74.122 ( 95.609)       HD95_TC  95.609 ( 74.122)       HD95_ED 373.129 (373.129)     HD95_ET 373.129 (373.129)       HD95_RC 373.129 (373.129)
20231127 17:00:03 INFO: ==> Validation ends...
20231127 17:00:08 INFO: Train: [1][1/2] Time  4.651 ( 4.651)    Data  3.933 ( 3.933)    BCE 0.6457 (0.6457)     Dice 0.8298 (0.8298) Loss 1.4756 (1.4756)
20231127 17:00:08 INFO: ==> Validation starts...
seg_map (<class 'monai.data.meta_tensor.MetaTensor'>):  (1, 5, 240, 240, 155)
label (<class 'monai.data.meta_tensor.MetaTensor'>):  (1, 1, 240, 240, 155)
brats names: ['1_100918']
[[1.14249416e-01 1.01523873e-10 1.54320983e-08 3.21616830e-11
  3.65498395e-11]]
[[ 36.     373.1287 373.1287 373.1287 373.1287]]
Empty DataFrame
Columns: [Dice_BG, Dice_TC, Dice_ED, Dice_ET, Dice_RC, HD95_BG, HD95_TC, HD95_ED, HD95_ET, HD95_RC]
Index: []
['1_100918']
1
1.0152387e-10
0.114249416
1.5432098e-08
373.1287
36.0
373.1287
20231127 17:00:13 INFO: Val: [1][1/1]   Time  5.077 ( 5.077)    Dice_BG 0.114 (0.114)   Dice_TC 0.000 (0.000)   Dice_ED 0.000 (0.000)Dice_ET 0.000 (0.000)    Dice_RC 0.000 (0.000)   HD95_BG  36.000 (373.129)       HD95_TC 373.129 ( 36.000)       HD95_ED 373.129 (373.129)     HD95_ET 373.129 (373.129)       HD95_RC 373.129 (373.129)
20231127 17:00:13 INFO: ==> Validation ends...
20231127 17:00:18 INFO: Train: [2][1/2] Time  4.655 ( 4.655)    Data  3.952 ( 3.952)    BCE 0.6035 (0.6035)     Dice 0.8209 (0.8209) Loss 1.4244 (1.4244)
20231127 17:00:18 INFO: ==> Validation starts...
seg_map (<class 'monai.data.meta_tensor.MetaTensor'>):  (1, 5, 240, 240, 155)
label (<class 'monai.data.meta_tensor.MetaTensor'>):  (1, 1, 240, 240, 155)
brats names: ['1_100918']
[[1.8487457e-02 1.0152387e-10 1.0000000e+00 4.4407734e-11 4.3073000e-11]]
[[ 78.85429601 373.1287       0.         373.1287     373.1287    ]]
Empty DataFrame
Columns: [Dice_BG, Dice_TC, Dice_ED, Dice_ET, Dice_RC, HD95_BG, HD95_TC, HD95_ED, HD95_ET, HD95_RC]
Index: []
['1_100918']
1
1.0152387e-10
0.018487457
1.0
373.1287
78.85429601486528
0.0
20231127 17:00:24 INFO: Val: [2][1/1]   Time  5.299 ( 5.299)    Dice_BG 0.018 (0.018)   Dice_TC 0.000 (0.000)   Dice_ED 1.000 (0.000)Dice_ET 1.000 (0.000)    Dice_RC 1.000 (0.000)   HD95_BG  78.854 (373.129)       HD95_TC 373.129 ( 78.854)       HD95_ED   0.000 (373.129)     HD95_ET   0.000 (373.129)       HD95_RC   0.000 (373.129)
20231127 17:00:24 INFO: ==> Validation ends...
20231127 17:00:24 INFO: ==> Testing starts...
seg_map (<class 'monai.data.meta_tensor.MetaTensor'>):  (1, 5, 240, 240, 155)
label (<class 'monai.data.meta_tensor.MetaTensor'>):  (1, 1, 240, 240, 155)
brats names: ['1_020919']
[[1.2661329e-01 9.0305680e-11 1.0000000e+00 3.1665712e-11 3.5144072e-11]]
[[ 35.14256678 373.1287       0.         373.1287     373.1287    ]]
Empty DataFrame
Columns: [Dice_BG, Dice_TC, Dice_ED, Dice_ET, Dice_RC, HD95_BG, HD95_TC, HD95_ED, HD95_ET, HD95_RC]
Index: []
['1_020919']
1
9.030568e-11
0.12661329
1.0
373.1287
35.14256678161116
0.0
20231127 17:00:30 INFO: Test: [1][1/1]  Time  5.872 ( 5.872)    Dice_BG 0.127 (0.127)   Dice_TC 0.000 (0.000)   Dice_ED 1.000 (0.000)Dice_ET 1.000 (0.000)    Dice_RC 1.000 (0.000)   HD95_BG  35.143 (373.129)       HD95_TC 373.129 ( 35.143)       HD95_ED   0.000 (373.129)     HD95_ET   0.000 (373.129)       HD95_RC   0.000 (373.129)
20231127 17:00:30 INFO: ==> Saving...
20231127 17:00:30 INFO: ==> Testing ends...
```
- modification in misc.py: 
- from: 
```py
def update(self, dice, hd95, names, bsz):
    for i in range(bsz):
                self.cases.loc[names[i]] = [
                    dice[i, 1], dice[i, 0], dice[i, 2], 
                    hd95[i, 1], hd95[i, 0], hd95[i, 2],
                ]
```
- to: 
```py
def update(self, dice, hd95, names, bsz):
        for i in range(bsz):
            self.cases.loc[names[i]] = [
                dice[i, 0], dice[i, 1], dice[i, 2], dice[i, 3], dice[i, 4],
                hd95[i, 1], hd95[i, 0], hd95[i, 2], hd95[i, 3], hd95[i, 4],
            ]
```

- modification in infer() in tran_brats2021.py: 
```py
if (i == 0) or (i + 1) % args.print_freq == 0:
                mean_metrics = case_metrics_meter.mean()
                logger.info("\t".join([
                    f'{mode.capitalize()}: [{epoch}][{i+1}/{len(infer_loader)}]', str(batch_time), 
                    f"Dice_BG {dice[:, 0].mean():.3f} ({mean_metrics['Dice_BG']:.3f})", # background
                    f"Dice_TC {dice[:, 1].mean():.3f} ({mean_metrics['Dice_TC']:.3f})", # tumor core
                    f"Dice_ED {dice[:, 2].mean():.3f} ({mean_metrics['Dice_ET']:.3f})", # edema
                    f"Dice_ET {dice[:, 3].mean():.3f} ({mean_metrics['Dice_ET']:.3f})", # enhancing tumor
                    f"Dice_RC {dice[:, 4].mean():.3f} ({mean_metrics['Dice_ET']:.3f})", # resection cavity
                    f"HD95_BG {hd95[:, 0].mean():7.3f} ({mean_metrics['HD95_BG']:7.3f})", # background
                    f"HD95_TC {hd95[:, 1].mean():7.3f} ({mean_metrics['HD95_TC']:7.3f})", # tumor core
                    f"HD95_ED {hd95[:, 2].mean():7.3f} ({mean_metrics['HD95_ET']:7.3f})", # edema
                    f"HD95_ET {hd95[:, 3].mean():7.3f} ({mean_metrics['HD95_ET']:7.3f})", # enhancing tumor
                    f"HD95_RC {hd95[:, 4].mean():7.3f} ({mean_metrics['HD95_ET']:7.3f})", # resection cavity
                ]))
```
- example command:
```bash
python train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 5
```
- example output: 
```
(brats2023) tom@b760:~/Documents/y4_t1/fyp/3DUNet-BraTS-PyTorch$ python train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 5
20231127 17:10:40 INFO: -------------------- New Experiment --------------------
20231127 17:10:40 INFO: train_brats2021.py --dataset brats2023 --data_root ../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 5
20231127 17:10:40 INFO: Namespace(amp=False, batch_size=2, beta1=0.9, beta2=0.999, block='plain', cases_split='./data/split/brats2023_split_fold0.csv', channels_list=[32, 64, 128, 256, 320, 320], clip_grad=False, comment='', data_parallel=False, data_root='../brats2023/', dataset='brats2023', deep_supervision=False, dropout_prob=0.0, ds_layer=4, epochs=3, eval_freq=1, exp_dir='saved_model/_brats2023_unet_adamw_none_pos1.0_neg1.0_1127_171040', gpus=None, infer_batch_size=4, input_channels=4, kernel_size=3, lr=0.001, lr_gamma=0.1, milestones=[60, 80], neg_ratio=1.0, norm='instance', num_classes=5, num_workers=6, optim='adamw', patch_overlap=0.5, patch_size=128, pos_ratio=1.0, print_freq=5, save_freq=10, save_model=True, save_pred=True, scheduler='none', seed=1000, sliding_window_mode='constant', sw_batch_size=2, unet_arch='unet', warmup_epochs=5, weight_decay=0.0001, weight_path=None)
20231127 17:10:40 INFO: ==> Training starts...
20231127 17:11:05 INFO: Train: [0][1/2] Time 25.303 (25.303)    Data  4.631 ( 4.631)    BCE 0.6831 (0.6831)     Dice 0.8545 (0.8545) Loss 1.5376 (1.5376)
20231127 17:11:16 INFO: ==> Validation starts...
20231127 17:11:22 INFO: Val: [0][1/1]   Time  6.301 ( 6.301)    Dice_BG 0.023 (0.023)   Dice_TC 0.000 (0.000)   Dice_ED 0.000 (0.000)Dice_ET 0.000 (0.000)    Dice_RC 0.000 (0.000)   HD95_BG  75.406 (111.665)       HD95_TC 111.665 ( 75.406)       HD95_ED 373.129 (373.129)     HD95_ET 373.129 (373.129)       HD95_RC 373.129 (373.129)
20231127 17:11:22 INFO: ==> Validation ends...
20231127 17:11:27 INFO: Train: [1][1/2] Time  4.642 ( 4.642)    Data  3.931 ( 3.931)    BCE 0.6496 (0.6496)     Dice 0.8440 (0.8440) Loss 1.4936 (1.4936)
20231127 17:11:27 INFO: ==> Validation starts...
20231127 17:11:33 INFO: Val: [1][1/1]   Time  6.089 ( 6.089)    Dice_BG 0.064 (0.064)   Dice_TC 0.000 (0.000)   Dice_ED 0.000 (0.000)Dice_ET 0.000 (0.000)    Dice_RC 0.000 (0.000)   HD95_BG  75.703 ( 52.048)       HD95_TC  52.048 ( 75.703)       HD95_ED 373.129 (373.129)     HD95_ET 373.129 (373.129)       HD95_RC 373.129 (373.129)
20231127 17:11:33 INFO: ==> Validation ends...
20231127 17:11:38 INFO: Train: [2][1/2] Time  4.625 ( 4.625)    Data  3.926 ( 3.926)    BCE 0.6256 (0.6256)     Dice 0.8469 (0.8469) Loss 1.4725 (1.4725)
20231127 17:11:38 INFO: ==> Validation starts...
20231127 17:11:43 INFO: Val: [2][1/1]   Time  5.016 ( 5.016)    Dice_BG 0.041 (0.041)   Dice_TC 0.000 (0.000)   Dice_ED 1.000 (0.000)Dice_ET 0.000 (0.000)    Dice_RC 0.000 (0.000)   HD95_BG  79.328 (373.129)       HD95_TC 373.129 ( 79.328)       HD95_ED   0.000 (373.129)     HD95_ET 373.129 (373.129)       HD95_RC 373.129 (373.129)
20231127 17:11:43 INFO: ==> Validation ends...
20231127 17:11:43 INFO: ==> Testing starts...
20231127 17:11:50 INFO: Test: [0][1/1]  Time  6.934 ( 6.934)    Dice_BG 0.036 (0.036)   Dice_TC 0.000 (0.000)   Dice_ED 0.000 (0.000)Dice_ET 0.000 (0.000)    Dice_RC 0.000 (0.000)   HD95_BG  72.945 (117.607)       HD95_TC 117.607 ( 72.945)       HD95_ED 373.129 (373.129)     HD95_ET 373.129 (373.129)       HD95_RC 373.129 (373.129)
20231127 17:11:50 INFO: ==> Saving...
20231127 17:11:50 INFO: ==> Testing ends...
```
## 2239
```
(brats2023) gpu38:/research/d2/fyp23/hmli1/code/3DUNet-BraTS-PyTorch> python train_brats2021.py --dataset brats2023 --data_root ../../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 5
20231127 22:37:15 INFO: -------------------- New Experiment --------------------
20231127 22:37:15 INFO: train_brats2021.py --dataset brats2023 --data_root ../../brats2023/ --cases_split ./data/split/brats2023_split_fold0.csv --epochs 3 --eval_freq 1 --save_model --save_pred --exp_dir saved_model/ --num_classes 5
20231127 22:37:15 INFO: Namespace(amp=False, batch_size=2, beta1=0.9, beta2=0.999, block='plain', cases_split='./data/split/brats2023_split_fold0.csv', channels_list=[32, 64, 128, 256, 320, 320], clip_grad=False, comment='', data_parallel=False, data_root='../../brats2023/', dataset='brats2023', deep_supervision=False, dropout_prob=0.0, ds_layer=4, epochs=3, eval_freq=1, exp_dir='saved_model/_brats2023_unet_adamw_none_pos1.0_neg1.0_1127_223715', gpus=None, infer_batch_size=4, input_channels=4, kernel_size=3, lr=0.001, lr_gamma=0.1, milestones=[60, 80], neg_ratio=1.0, norm='instance', num_classes=5, num_workers=6, optim='adamw', patch_overlap=0.5, patch_size=128, pos_ratio=1.0, print_freq=5, save_freq=10, save_model=True, save_pred=True, scheduler='none', seed=1000, sliding_window_mode='constant', sw_batch_size=2, unet_arch='unet', warmup_epochs=5, weight_decay=0.0001, weight_path=None)
20231127 22:37:19 INFO: ==> Training starts...
base_dir:  ../../brats2023/brats2023/1_020919/1_020919
20231127 22:37:35 INFO: Train: [0][1/1] Time 15.903 (15.903)    Data  5.792 ( 5.792)    BCE 0.6858 (0.6858)     Dice 0.8638 (0.8638)     Loss 1.5496 (1.5496)
20231127 22:37:35 INFO: ==> Validation starts...
base_dir:  ../../brats2023/brats2023/1_040520/1_040520
20231127 22:37:53 INFO: Val: [0][1/1]   Time 17.960 (17.960)    Dice_BG 0.016 (0.016)   Dice_TC 0.024 (0.024)   Dice_ED 0.000 (0.000)    Dice_ET 0.000 (0.000)   Dice_RC 0.000 (0.000)   HD95_BG  73.797 (135.059)       HD95_TC 135.059 ( 73.797)       HD95_ED 373.129 (373.129)        HD95_ET 373.129 (373.129)       HD95_RC 373.129 (373.129)
20231127 22:37:53 INFO: ==> Validation ends...
base_dir:  ../../brats2023/brats2023/1_020919/1_020919
20231127 22:37:58 INFO: Train: [1][1/1] Time  5.450 ( 5.450)    Data  4.688 ( 4.688)    BCE 0.6722 (0.6722)     Dice 0.8621 (0.8621)     Loss 1.5343 (1.5343)
20231127 22:37:58 INFO: ==> Validation starts...
base_dir:  ../../brats2023/brats2023/1_040520/1_040520
20231127 22:38:13 INFO: Val: [1][1/1]   Time 14.272 (14.272)    Dice_BG 0.002 (0.002)   Dice_TC 0.007 (0.007)   Dice_ED 0.000 (0.000)    Dice_ET 0.000 (0.000)   Dice_RC 0.000 (0.000)   HD95_BG  74.458 (132.458)       HD95_TC 132.458 ( 74.458)       HD95_ED 373.129 (373.129)        HD95_ET 373.129 (373.129)       HD95_RC 373.129 (373.129)
20231127 22:38:13 INFO: ==> Validation ends...
base_dir:  ../../brats2023/brats2023/1_020919/1_020919
20231127 22:38:18 INFO: Train: [2][1/1] Time  5.516 ( 5.516)    Data  4.742 ( 4.742)    BCE 0.6421 (0.6421)     Dice 0.8605 (0.8605)     Loss 1.5026 (1.5026)
20231127 22:38:19 INFO: ==> Validation starts...
base_dir:  ../../brats2023/brats2023/1_040520/1_040520
20231127 22:38:33 INFO: Val: [2][1/1]   Time 14.184 (14.184)    Dice_BG 0.003 (0.003)   Dice_TC 0.002 (0.002)   Dice_ED 0.000 (0.000)    Dice_ET 0.000 (0.000)   Dice_RC 0.000 (0.000)   HD95_BG  83.588 (135.963)       HD95_TC 135.963 ( 83.588)       HD95_ED 373.129 (373.129)        HD95_ET 373.129 (373.129)       HD95_RC 373.129 (373.129)
20231127 22:38:33 INFO: ==> Validation ends...
20231127 22:38:33 INFO: ==> Testing starts...
base_dir:  ../../brats2023/brats2023/1_040618/1_040618
20231127 22:38:47 INFO: Test: [0][1/1]  Time 13.823 (13.823)    Dice_BG 0.007 (0.007)   Dice_TC 0.023 (0.023)   Dice_ED 0.000 (0.000)    Dice_ET 0.000 (0.000)   Dice_RC 0.000 (0.000)   HD95_BG  66.948 (128.160)       HD95_TC 128.160 ( 66.948)       HD95_ED 373.129 (373.129)        HD95_ET 373.129 (373.129)       HD95_RC 373.129 (373.129)
20231127 22:38:47 INFO: ==> Saving...
20231127 22:38:47 INFO: ==> Testing ends...
```